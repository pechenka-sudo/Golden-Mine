<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golden Mine - Живая шахта</title>
  <style>
    * { box-sizing: border-box; user-select: none; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0e68c, #daa520);
      margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: center;
      height: 100vh;
      color: #4b3b00;
    }
    #app {
      background: #fff8dc;
      padding: 30px 25px;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(184, 134, 11, 0.6);
      width: 400px;
      max-width: 95vw;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    h1 {
      color: #b8860b;
      margin-bottom: 24px;
      font-weight: 900;
      letter-spacing: 1.5px;
    }
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 14px;
      margin: 8px 0 14px 0;
      border-radius: 12px;
      border: 2px solid #b8860b;
      font-size: 16px;
      outline-offset: 2px;
      outline-color: #ffd700;
      transition: border-color 0.3s ease;
    }
    input[type="email"]:focus,
    input[type="password"]:focus {
      border-color: #ffdb58;
    }
    button {
      width: 100%;
      padding: 14px 0;
      margin-top: 14px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 16px;
      border: none;
      background: #b8860b;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: #ffdb58;
      color: #6b4f00;
    }
    button:disabled {
      background-color: #d3b97a;
      cursor: default;
      color: #6b4f00;
    }
    .error {
      height: 22px;
      margin: 4px 0 8px 0;
      color: #c53030;
      font-weight: 600;
      min-height: 22px;
    }
    #game {
      display: none;
      user-select: none;
    }
    #coins {
      font-weight: 900;
      font-size: 26px;
      margin-bottom: 18px;
      text-shadow: 0 0 8px #b8860b;
    }
    #user-email {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 12px;
      display: block;
      color: #5f4b00;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .btn-small {
      width: 48%;
      display: inline-block;
      margin: 10px 1%;
      font-size: 14px;
      padding: 10px 0;
      border-radius: 12px;
      font-weight: 600;
    }
    #mine-btn {
      background: #d1af43;
      box-shadow: 0 3px 10px #d1af4370;
    }
    #upgrade-btn {
      background: #a3740f;
      box-shadow: 0 3px 10px #a3740f70;
      color: #fff;
    }
    #hire-btn {
      background: #4a7c0f;
      box-shadow: 0 3px 10px #4a7c0f70;
      color: #fff;
    }
    #logout-btn {
      background: #a63232;
      box-shadow: 0 3px 10px #a6323270;
      color: #fff;
      margin-top: 18px;
    }
    #miners-info {
      margin: 12px 0;
      font-weight: 700;
      font-size: 16px;
      color: #705900;
    }
    /* Прогресс бар добычи */
    #progress-bar-container {
      width: 100%;
      height: 18px;
      background: #b8860b33;
      border-radius: 9px;
      margin: 12px 0 18px 0;
      overflow: hidden;
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background: #ffd700;
      transition: width 0.25s ease;
      border-radius: 9px 0 0 9px;
    }
    /* Анимация шахтера */
    #miner-anim {
      margin: 0 auto 20px auto;
      width: 80px;
      height: 80px;
      position: relative;
      user-select: none;
    }
    /* Качаемый молот */
    #hammer {
      width: 40px;
      height: 40px;
      background: #d4af37;
      border-radius: 6px 12px 6px 12px;
      position: absolute;
      top: 20px;
      left: 20px;
      transform-origin: top left;
      animation: swing 1s infinite ease-in-out;
      box-shadow: 0 0 6px #ffd700aa;
    }
    /* Голова шахтера */
    #head {
      width: 30px;
      height: 30px;
      background: #c28e00;
      border-radius: 50%;
      position: absolute;
      top: 15px;
      left: 45px;
      box-shadow: 0 0 10px #b8860b88;
    }
    /* Тело шахтера */
    #body {
      width: 28px;
      height: 40px;
      background: #d4af37;
      border-radius: 8px;
      position: absolute;
      top: 40px;
      left: 44px;
      box-shadow: inset 0 0 8px #a57e00;
    }
    /* Анимация удара молотом */
    @keyframes swing {
      0% { transform: rotate(20deg); }
      50% { transform: rotate(-20deg); }
      100% { transform: rotate(20deg); }
    }

    /* Banner styles */
    #banner-container {
      position: fixed;
      bottom: 0;
      left: 0; right: 0;
      width: 100%;
      background: rgba(0,0,0,0.5);
      text-align: center;
      z-index: 99999;
      padding: 10px 0 0 0;
    }
    #banner-frame {
      margin: 0 auto;
      width: 70%;
      height: auto;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 0 10px #0009 inset;
    }
    #banner-close-label {
      position: absolute;
      top: 50%;
      right: 24px;
      transform: translateY(-50%);
      background: rgba(248,248,249,0.7);
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      z-index: 100000;
      user-select: none;
    }
    #banner-close-label svg {
      display: block;
      fill: #000000;
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>

  <div id="app">
    <div id="auth">
      <h1>Golden Mine</h1>
      <input id="email" type="email" placeholder="Введите email" autocomplete="username" />
      <input id="password" type="password" placeholder="Введите пароль" autocomplete="current-password" />
      <div class="error" id="auth-error"></div>
      <button id="btn-signin">Войти</button>
      <button id="btn-signup">Регистрация</button>
    </div>

    <div id="game">
      <h1>Добро пожаловать, <span id="user-email"></span>!</h1>

      <div id="miner-anim">
        <div id="hammer"></div>
        <div id="head"></div>
        <div id="body"></div>
      </div>

      <div id="coins">Золото: 0</div>
      <div id="miners-info">Шахтёры: 1 (Уровень: 1)</div>

      <div id="progress-bar-container" title="Прогресс добычи">
        <div id="progress-bar"></div>
      </div>

      <button id="mine-btn" class="btn-small">Добыть золото вручную</button>
      <button id="upgrade-btn" class="btn-small" disabled>Улучшить шахтёра (стоимость: 10)</button>
      <button id="hire-btn" class="btn-small" disabled>Нанять шахтёров (стоимость: 15)</button>
      <button id="logout-btn">Выйти</button>
      <div class="error" id="game-error"></div>
    </div>
  </div>

  <!-- Рекламный баннер -->
  <div style="position: absolute; z-index: 99999">
    <input autocomplete="off" type="checkbox" id="aadsstickyme80rm2l" hidden />
    <div style="padding-top: 0; padding-bottom: auto;">
      <div style="width:100%;height:auto;position:fixed;text-align:center;font-size:0;bottom:0;left:0;right:0;margin:auto">
        <label for="aadsstickyme80rm2l" id="banner-close-label" title="Закрыть рекламу">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 490 490"><polygon points="456.851,0 245,212.564 33.149,0 0.708,32.337 212.669,245.004 0.708,457.678 33.149,490 245,277.443 456.851,490 489.292,457.678 277.331,245.004 489.292,32.337 "/></svg>
        </label>
        <div id="banner-frame">
          <iframe data-aa=2406373 src="//acceptable.a-ads.com/2406373/?size=Adaptive" style="border:0; padding:0; width:100%; height:auto; overflow:hidden; margin: auto"></iframe>
        </div>
      </div>
    </div>
    <style>
      #aadsstickyme80rm2l:checked + div {
        display: none;
      }
    </style>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // === Firebase config ===
  const firebaseConfig = {
    apiKey: "AIzaSyCXfzRrHa2t-y5TBJoipN0m_mv9bXjHmL8",
    authDomain: "golden-mine-e7d50.firebaseapp.com",
    databaseURL: "https://golden-mine-e7d50-default-rtdb.firebaseio.com",
    projectId: "golden-mine-e7d50",
    storageBucket: "golden-mine-e7d50.firebasestorage.app",
    messagingSenderId: "49056047000",
    appId: "1:49056047000:web:76e20efa45a0b8ffc415ed",
    measurementId: "G-MMD56ZP5YE"
  };

  // === Initialize Firebase ===
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // === DOM Elements ===
  const authDiv = document.getElementById('auth');
  const gameDiv = document.getElementById('game');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const authError = document.getElementById('auth-error');
  const btnSignIn = document.getElementById('btn-signin');
  const btnSignUp = document.getElementById('btn-signup');
  const userEmailSpan = document.getElementById('user-email');
  const coinsDiv = document.getElementById('coins');
  const mineBtn = document.getElementById('mine-btn');
  const upgradeBtn = document.getElementById('upgrade-btn');
  const hireBtn = document.getElementById('hire-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const gameError = document.getElementById('game-error');
  const progressBar = document.getElementById('progress-bar');

  // === Game variables ===
  let coins = 0;
  let miningPower = 1;
  let upgradeCost = 10;
  let hireCost = 15;
  let minersCount = 1;
  let isMiningAuto = false;
  let autoMineProgress = 0; // от 0 до 1
  const autoMineDuration = 4000; // 4 секунды полный цикл авто добычи

  let currentUser = null;

  // === Audio setup ===
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function playTone(freq, duration = 0.1, type = "sine", volume = 0.05) {
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.type = type;
    oscillator.frequency.value = freq;
    gainNode.gain.value = volume;
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();

    oscillator.stop(audioCtx.currentTime + duration);
    oscillator.onended = () => {
      gainNode.disconnect();
      oscillator.disconnect();
    };
  }

  function playMineSound() {
    playTone(350, 0.05, "square", 0.07);
    setTimeout(() => playTone(450 + Math.random() * 40, 0.07, "triangle", 0.05), 60);
  }

  function playUpgradeSound() {
    playTone(600, 0.12, "sine", 0.1);
    setTimeout(() => playTone(720, 0.12, "sine", 0.08), 140);
    setTimeout(() => playTone(840, 0.12, "sine", 0.06), 280);
  }

  function playErrorSound() {
    playTone(220, 0.2, "sine", 0.1);
  }

  function playClickSound() {
    playTone(500, 0.08, "triangle", 0.04);
  }

  // === Update UI ===
  function updateUI() {
    coinsDiv.textContent = `Золото: ${coins}`;
    upgradeBtn.textContent = `Улучшить шахтёра (стоимость: ${upgradeCost})`;
    hireBtn.textContent = `Нанять шахтёров (стоимость: ${hireCost})`;
    upgradeBtn.disabled = coins < upgradeCost;
    hireBtn.disabled = coins < hireCost;
    document.getElementById('miners-info').textContent = `Шахтёры: ${minersCount} (Уровень: ${miningPower})`;
  }

  // === Load & Save Game Data ===
  async function loadGameData(uid) {
    const dataRef = ref(db, 'users/' + uid);
    const snapshot = await get(dataRef);
    if (snapshot.exists()) {
      const data = snapshot.val();
      coins = data.coins || 0;
      miningPower = data.miningPower || 1;
      upgradeCost = data.upgradeCost || 10;
      hireCost = data.hireCost || 15;
      minersCount = data.minersCount || 1;
    } else {
      coins = 0;
      miningPower = 1;
      upgradeCost = 10;
      hireCost = 15;
      minersCount = 1;
      await set(dataRef, { coins, miningPower, upgradeCost, hireCost, minersCount });
    }
    updateUI();
    startAutoMining();
  }

  async function saveGameData(uid) {
    const dataRef = ref(db, 'users/' + uid);
    await update(dataRef, { coins, miningPower, upgradeCost, hireCost, minersCount });
  }

  // === Auto mining logic ===
  function startAutoMining() {
    if (isMiningAuto) return;
    isMiningAuto = true;
    autoMineProgress = 0;
    requestAnimationFrame(autoMineLoop);
  }

  function autoMineLoop(timestamp) {
    if (!isMiningAuto) return;
    autoMineProgress += 16 / autoMineDuration; // приближение к 60 FPS
    if (autoMineProgress >= 1) {
      coins += miningPower * minersCount;
      updateUI();
      saveGameData(currentUser.uid);
      playMineSound();
      animateHammer();
      autoMineProgress = 0;
    }
    progressBar.style.width = `${autoMineProgress * 100}%`;
    requestAnimationFrame(autoMineLoop);
  }

  // === Hammer animation restart ===
  function animateHammer() {
    const hammer = document.getElementById('hammer');
    hammer.style.animation = 'none';
    // перезапускаем анимацию
    void hammer.offsetWidth;
    hammer.style.animation = '';
  }

  // === Button Handlers ===
  btnSignUp.onclick = async () => {
    authError.textContent = "";
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      currentUser = userCredential.user;
      userEmailSpan.textContent = currentUser.email;
      await loadGameData(currentUser.uid);
      authDiv.style.display = "none";
      gameDiv.style.display = "block";
      playClickSound();
    } catch (error) {
      authError.textContent = error.message;
      playErrorSound();
    }
  };

  btnSignIn.onclick = async () => {
    authError.textContent = "";
    try {
      const userCredential = await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
      currentUser = userCredential.user;
      userEmailSpan.textContent = currentUser.email;
      await loadGameData(currentUser.uid);
      authDiv.style.display = "none";
      gameDiv.style.display = "block";
      playClickSound();
    } catch (error) {
      authError.textContent = error.message;
      playErrorSound();
    }
  };

  logoutBtn.onclick = async () => {
    await signOut(auth);
    currentUser = null;
    authDiv.style.display = "block";
    gameDiv.style.display = "none";
    emailInput.value = "";
    passwordInput.value = "";
    coins = 0;
    miningPower = 1;
    upgradeCost = 10;
    hireCost = 15;
    minersCount = 1;
    updateUI();
    isMiningAuto = false;
    playClickSound();
  };

  mineBtn.onclick = () => {
    coins += miningPower;
    updateUI();
    saveGameData(currentUser.uid);
    playMineSound();
    animateHammer();
  };

  upgradeBtn.onclick = () => {
    if (coins >= upgradeCost) {
      coins -= upgradeCost;
      miningPower += 1;
      upgradeCost = Math.floor(upgradeCost * 2);
      updateUI();
      saveGameData(currentUser.uid);
      gameError.textContent = "";
      playUpgradeSound();
    } else {
      gameError.textContent = "Недостаточно золота для улучшения!";
      playErrorSound();
    }
  };

  hireBtn.onclick = () => {
    if (coins >= hireCost) {
      coins -= hireCost;
      minersCount += 1;
      hireCost = Math.floor(hireCost * 2);
      updateUI();
      saveGameData(currentUser.uid);
      gameError.textContent = "";
      playUpgradeSound();
    } else {
      gameError.textContent = "Недостаточно золота для найма шахтёров!";
      playErrorSound();
    }
  };

  // === Firebase Auth state observer ===
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      userEmailSpan.textContent = user.email;
      loadGameData(user.uid);
      authDiv.style.display = "none";
      gameDiv.style.display = "block";
    } else {
      currentUser = null;
      authDiv.style.display = "block";
      gameDiv.style.display = "none";
      isMiningAuto = false;
    }
  });

  updateUI();

</script>

</body>
</html>
